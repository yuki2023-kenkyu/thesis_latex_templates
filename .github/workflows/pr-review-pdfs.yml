name: PR Review PDFs (build + latexdiff)

on:
  pull_request:

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  pr-review:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install latexdiff
        run: |
          sudo apt-get update
          sudo apt-get install -y latexdiff

      # 1) Build "normal" PDFs (for reviewers to compare with the diff PDF)
      - name: Compile LaTeX (LuaLaTeX + biber)
        uses: xu-cheng/latex-action@v4
        with:
          root_file: |
            main.tex
            style_guide_updated.tex
          latexmk_use_lualatex: true

      - name: Upload built PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pr-pdf
          path: |
            main.pdf
            style_guide_updated.pdf

      # 2) Generate and build the diff PDF
      - name: Generate diff TeX (base vs head)
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          rm -rf diff
          # Japanese-friendly, robust default style: color-only (no ulem)
          latexdiff-vc \
            --encoding=utf8 \
            --math-markup=coarse \
            --graphics-markup=new-only \
            --preamble=preambles/latexdiff_preamble_ja_color.ltxdiff \
            --git --flatten --force -d diff -r "${BASE_SHA}" -r "${HEAD_SHA}" main.tex
          test -f diff/main.tex

      - name: Compile diff TeX (LuaLaTeX + biber)
        uses: xu-cheng/latex-action@v4
        with:
          root_file: diff/main.tex
          latexmk_use_lualatex: true

      - name: Upload diff PDF
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff-pdf
          path: diff/main.pdf

      # 3) Post (or update) a PR comment with artifact links
      - name: Build PR comment body
        id: pr-comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;

            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifacts = res.data.artifacts || [];

            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;
            const artifactLines = artifacts
              .sort((a, b) => a.name.localeCompare(b.name))
              .map(a => {
                const url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}/artifacts/${a.id}`;
                return `- [${a.name}](${url})`;
              })
              .join("\n");

            const body = [
              '<!-- pr-review-pdfs -->',
              '### Review PDFs (auto-generated)',
              '',
              `Workflow run: ${runUrl}`,
              '',
              'Artifacts:',
              artifactLines || '- (no artifacts found)',
              '',
              'Diff style: **Japanese-safe color markup** (no underline).',
              'If you prefer underline/strikeout, generate locally with `LTXDIFF_STYLE=ja-underline`.',
            ].join("\n");

            core.setOutput('body', body);

      - name: Find existing PR comment
        id: find-comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: '<!-- pr-review-pdfs -->'

      - name: Create or update PR comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: ${{ steps.pr-comment.outputs.body }}
