name: PR Review PDFs (build + latexdiff)

on:
  pull_request:

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  pr-review:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # latexdiff-vc --flatten が latexpand を要求するため、texlive-extra-utils を入れる
      - name: Install latexdiff + latexpand dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends latexdiff texlive-extra-utils

      # 1) Build "normal" PDFs (for reviewers to compare with the diff PDF)
      - name: Compile LaTeX (LuaLaTeX + biber)
        uses: xu-cheng/latex-action@v4
        with:
          root_file: |
            main.tex
            style_guide_updated.tex
          latexmk_use_lualatex: true
          # latexmkrc 等で outdir を変えていても、ここで上書きして PDF を確実にリポジトリ直下へ
          args: -interaction=nonstopmode -file-line-error -halt-on-error -outdir=.

      - name: Upload built PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pr-pdf
          path: |
            main.pdf
            style_guide_updated.pdf

      # 2) Generate and build the diff PDF
      - name: Generate diff TeX (base vs head)
        run: |
          set -euxo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          rm -rf diff

          # Japanese-friendly, robust default style: color-only (no ulem)
          latexdiff-vc \
            --git --force --flatten \
            --encoding=utf8 \
            --math-markup=coarse \
            --graphics-markup=new-only \
            --preamble=preambles/latexdiff_preamble_ja_color.ltxdiff \
            -d diff \
            -r "${BASE_SHA}" -r "${HEAD_SHA}" \
            main.tex

      - name: Add change summary into diff TeX
        run: |
          set -euxo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_SHORT="$(echo "${BASE_SHA}" | cut -c1-7)"
          HEAD_SHORT="$(echo "${HEAD_SHA}" | cut -c1-7)"
          BASE_LABEL="${BASE_REF}@${BASE_SHORT}"
          HEAD_LABEL="${HEAD_REF}@${HEAD_SHORT}"

          # git diff が失敗してもファイル自体は必ず存在させる（python 側で read できるように）
          mkdir -p diff
          : > diff/.changed_files.txt
          git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" -- >> diff/.changed_files.txt || true

          BASE_LABEL="${BASE_LABEL}" HEAD_LABEL="${HEAD_LABEL}" python3 - <<'PY'
import os, re
from pathlib import Path

def esc(s: str) -> str:
    s = s.replace("\\", "/")
    s = re.sub(r'([#\$%&_{}])', r'\\\1', s)
    s = s.replace("^", r"\textasciicircum{}")
    s = s.replace("~", r"\textasciitilde{}")
    return s

base_label = os.environ.get("BASE_LABEL", "")
head_label = os.environ.get("HEAD_LABEL", "")

changed_path = Path("diff/.changed_files.txt")
changed = [l.strip() for l in changed_path.read_text(encoding="utf-8", errors="ignore").splitlines() if l.strip()]

seen = set()
uniq = []
for p in changed:
    key = p.lower().replace("\\", "/")
    if key not in seen:
        seen.add(key)
        uniq.append(p)

tex, bib, img, other = [], [], [], []
for p in uniq:
    ext = Path(p).suffix.lower()
    if ext == ".tex":
        tex.append(p)
    elif ext in {".bib", ".bbx", ".cbx"}:
        bib.append(p)
    elif ext in {".pdf", ".png", ".jpg", ".jpeg", ".eps", ".svg"}:
        img.append(p)
    else:
        other.append(p)

lines = []
lines.append("% Auto-generated by GitHub Actions (pr-review-pdfs.yml)")
lines.append(r"\begingroup")
lines.append(r"\ifdefined\chapter\chapter*{Changes in this diff}\else\section*{Changes in this diff}\fi")
lines.append(r"\noindent\texttt{Base: " + esc(base_label) + r"}\\")
lines.append(r"\texttt{Head: " + esc(head_label) + r"}")
lines.append(r"\par\medskip")
lines.append(r"\noindent\textbf{Changed files (grouped):}")
lines.append(r"\begin{itemize}")

def add_group(title, items):
    if not items:
        return
    lines.append(r"  \item \textbf{" + title + "}")
    lines.append(r"  \begin{itemize}")
    for it in items:
        lines.append(r"    \item \texttt{" + esc(it) + "}")
    lines.append(r"  \end{itemize}")

add_group("TeX sources", tex)
add_group("Bibliography / styles", bib)
add_group("Images / figures", img)
add_group("Other files", other)
if not (tex or bib or img or other):
    # itemize が空だと LaTeX が「missing \item」で落ちるので必ず 1 個入れる
    lines.append(r"  \item \textit{(No changed files detected by git diff.)}")

lines.append(r"\end{itemize}")
lines.append(r"\endgroup")
lines.append("")

Path("diff/change_summary.tex").write_text("\n".join(lines), encoding="utf-8")

root = Path("diff/main.tex")
tex_src = root.read_text(encoding="utf-8", errors="ignore")

# 二重挿入防止
if re.search(r"\\input\{change_summary\.tex\}", tex_src):
    root.write_text(tex_src, encoding="utf-8")
    raise SystemExit(0)

m = re.search(r"\\begin\{document\}", tex_src)
if not m:
    raise SystemExit("Could not find \\\\begin{document} in diff/main.tex")

ins = "\\input{change_summary.tex}\n\\clearpage\n"
tex_out = tex_src[:m.end()] + "\n" + ins + tex_src[m.end():]
root.write_text(tex_out, encoding="utf-8")
PY

      - name: Compile diff TeX (LuaLaTeX + biber)
        uses: xu-cheng/latex-action@v4
        with:
          working_directory: diff
          root_file: main.tex
          latexmk_use_lualatex: true
          args: -interaction=nonstopmode -file-line-error -halt-on-error -outdir=.

      - name: Upload diff PDF
        uses: actions/upload-artifact@v4
        with:
          name: pr-diff-pdf
          path: diff/main.pdf

      # 3) Post (or update) a PR comment with artifact links
      - name: Build PR comment body
        id: pr-comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;

            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifacts = res.data.artifacts || [];

            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${run_id}`;
            const artifactLines = artifacts
              .sort((a, b) => a.name.localeCompare(b.name))
              .map(a => {
                const url = `https://github.com/${owner}/${repo}/actions/runs/${run_id}/artifacts/${a.id}`;
                return `- [${a.name}](${url})`;
              })
              .join("\n");

            const body = [
              '<!-- pr-review-pdfs -->',
              '### Review PDFs (auto-generated)',
              '',
              `Workflow run: ${runUrl}`,
              '',
              'Artifacts:',
              artifactLines || '- (no artifacts found)',
              '',
              'Diff style: **Japanese-safe color markup** (no underline).',
              'If you prefer underline/strikeout, generate locally with `LTXDIFF_STYLE=ja-underline`.',
            ].join("\n");

            core.setOutput('body', body);

      - name: Find existing PR comment
        id: find-comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: '<!-- pr-review-pdfs -->'

      - name: Create or update PR comment
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: ${{ steps.pr-comment.outputs.body }}
